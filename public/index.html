<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8faf9;
            color: #2d3748;
            line-height: 1.6;
        }

        /* Показываем контент сразу без авторизации */
        .main-content {
            display: block !important;
        }

        /* Убран CSS для loader-spinner */

        /* Боковое меню */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: white;
            border-right: 1px solid #e2e8f0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid #e2e8f0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00796b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #f1f5f9;
            color: #00796b;
        }

        .nav-item.active {
            background: #e0f2f1;
            color: #00796b;
            border-right: 3px solid #00796b;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        /* Основной контент */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            background: #f8faf9;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #1a202c;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: #1a202c;
            line-height: 1.2;
        }

        .user-role {
            font-size: 12px;
            color: #64748b;
            line-height: 1.2;
        }

        .logout-btn {
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px 12px;
            color: #64748b;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #f1f5f9;
            color: #1a202c;
        }

        .content {
            padding: 30px;
        }

        /* Кнопки */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #00796b;
            color: white;
        }

        .btn-primary:hover {
            background: #00695c;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-number.total { color: #00796b; }
        .stat-number.completed { color: #4caf50; }
        .stat-number.pending { color: #ff9800; }
        .stat-number.overdue { color: #f44336; }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        /* Карточки задач */
        .tasks-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .tasks-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-tabs {
            display: flex;
            gap: 5px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
        }

        .tab.active {
            background: #e0f2f1;
            color: #00796b;
        }

        .task-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            padding: 20px 25px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .task-item:hover {
            background: #f8faf9;
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1a202c;
        }

        .task-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #64748b;
        }

        .task-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .status-review {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-revision {
            background: #fbe9e7;
            color: #d84315;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a202c;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        /* Формы */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #00796b;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Список сотрудников */
        .employee-list {
            display: grid;
            gap: 15px;
        }

        .employee-card {
            background: #f8faf9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #00796b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .employee-details h4 {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .employee-details p {
            font-size: 13px;
            color: #64748b;
        }


        /* Адаптивность */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Боковое меню -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                Task Manager
            </div>
        </div>
        <nav class="nav-menu">
            <button class="nav-item active" onclick="showPage('dashboard')">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                </svg>
                Дашборд
            </button>
            <button class="nav-item" onclick="showPage('analytics')">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16,11V3H8v6H2v12h20V11H16z M10,5h4v14h-4V5z M4,11h4v8H4V11z M20,19h-4v-6h4V19z"/>
                </svg>
                Аналитика
            </button>
            <button class="nav-item" onclick="showPage('users')">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2c2.21 0 4 1.79 4 4 0 2.21-1.59 3.92-3.75 4l.75.75 2.25 2.25c.39.39.39 1.02 0 1.41s-1.02.39-1.41 0L11.59 12.16c-.59.13-1.2.34-1.8.34C7.58 12.5 6 10.92 6 9s1.58-3.5 3.79-3.5zM10 7c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
                    <path d="M16 13c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM18 17v-1.5c0-1.38-1.12-2.5-2.5-2.5h-3c-1.38 0-2.5 1.12-2.5 2.5V17h8z"/>
                </svg>
                Пользователи
            </button>
            <button class="nav-item" onclick="showPage('admin')" id="adminNavItem" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Админ
            </button>
            <button class="nav-item" onclick="showPage('settings')">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                Настройки
            </button>
        </nav>
    </div>

    <!-- Убран loader авторизации -->

    <!-- Основной контент -->
    <div class="main-content" id="mainContent">
        <!-- Дашборд -->
        <div id="dashboard-page" class="page">
            <div class="header">
                <h1 class="page-title">Дашборд</h1>
                <div class="header-actions">
                    <div class="user-info" id="userInfo">
                        <img src="" alt="Avatar" class="user-avatar" id="userAvatar">
                        <div class="user-details">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">...</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Выйти</button>
                    <button class="btn btn-primary" onclick="openTaskModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Новая задача
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number total" id="totalTasks">8</div>
                        <div class="stat-label">Всего задач</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number completed" id="completedTasks">5</div>
                        <div class="stat-label">Выполнено</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number pending" id="pendingTasks">2</div>
                        <div class="stat-label">В работе</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number overdue" id="overdueTasks">1</div>
                        <div class="stat-label">Просрочено</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #2196f3;" id="reviewTasks">0</div>
                        <div class="stat-label">На проверке</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #ff5722;" id="revisionTasks">0</div>
                        <div class="stat-label">На доработке</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #9c27b0;" id="avgCompletionTime">0</div>
                        <div class="stat-label">Ср. время (мин)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #607d8b;" id="avgEfficiency">0%</div>
                        <div class="stat-label">Эффективность</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #795548;" id="totalRevisions">0</div>
                        <div class="stat-label">Всего доработок</div>
                    </div>
                </div>

                <div class="tasks-container">
                    <div class="tasks-header">
                        <h3>Задачи</h3>
                        <div class="filter-tabs">
                            <button class="tab active" onclick="filterTasks('all')">Все</button>
                            <button class="tab" onclick="filterTasks('pending')">В работе</button>
                            <button class="tab" onclick="filterTasks('review')">На проверке</button>
                            <button class="tab" onclick="filterTasks('revision')">На доработке</button>
                            <button class="tab" onclick="filterTasks('completed')">Выполнено</button>
                            <button class="tab" onclick="filterTasks('overdue')">Просрочено</button>
                        </div>
                    </div>
                    <div class="task-list" id="taskList">
                        <!-- Задачи будут добавляться динамически -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница сотрудников удалена -->


        <!-- Страница аналитики -->
        <div id="analytics-page" class="page" style="display: none;">
            <div class="header">
                <h1 class="page-title">Аналитика</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadAnalytics()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8z"/>
                            <path d="M12 18c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        Обновить
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="tasks-container">
                    <div class="tasks-header">
                        <h3>Статистика по исполнителям</h3>
                    </div>
                    <div style="padding: 25px;">
                        <div id="detailedStatsContainer">
                            <!-- Детальная статистика будет загружаться динамически -->
                        </div>
                    </div>
                </div>
                
                <div class="tasks-container" style="margin-top: 30px;">
                    <div class="tasks-header">
                        <h3>Производительность за последние 30 дней</h3>
                    </div>
                    <div style="padding: 25px;">
                        <div id="performanceMetricsContainer">
                            <!-- Метрики производительности будут загружаться динамически -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница пользователей -->
        <div id="users-page" class="page" style="display: none;">
            <div class="header">
                <h1 class="page-title">Управление пользователями</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshUsers()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8z"/>
                            <path d="M12 18c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        Обновить
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="tasks-container">
                    <div class="tasks-header">
                        <h3>Пользователи из настроенного чата</h3>
                        <div style="font-size: 14px; color: #64748b;">
                            Отображаются пользователи, которые взаимодействовали с ботом в настроенном чате.<br>
                            <strong>executor</strong> - исполнитель, <strong>manager</strong> - менеджер, <strong>admin</strong> - администратор
                        </div>
                    </div>
                    <div style="padding: 25px;">
                        <div id="usersList">
                            <!-- Пользователи будут загружаться динамически -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница админа -->
        <div id="admin-page" class="page" style="display: none;">
            <div class="header">
                <h1 class="page-title">Администрирование</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadAdminUsers()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8z"/>
                            <path d="M12 18c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        Обновить
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="tasks-container">
                    <div class="tasks-header">
                        <h3>🤖 Пользователи бота (токен: 7539351581:AAGn...)</h3>
                        <div style="font-size: 14px; color: #64748b;">
                            Все пользователи, которые активировали бота @workprobusinessbot и взаимодействовали с ним
                        </div>
                    </div>
                    <div style="padding: 25px;">
                        <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">📱 Активные пользователи бота</h4>
                            <p style="margin: 0; font-size: 14px; color: #388e3c;">
                                Здесь отображаются все пользователи, которые отправили хотя бы одну команду боту.
                                Пользователи автоматически добавляются при первом взаимодействии.
                            </p>
                        </div>
                        <div id="adminUsersList">
                            <!-- Пользователи будут загружаться динамически -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница настроек -->
        <div id="settings-page" class="page" style="display: none;">
            <div class="header">
                <h1 class="page-title">Настройки</h1>
            </div>
            <div class="content">
                <div class="tasks-container">
                    <div class="tasks-header">
                        <h3>Настройки системы</h3>
                    </div>
                    <div style="padding: 25px;">
                        <div class="form-group">
                            <label class="form-label">🤖 Telegram Bot</label>
                            <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <strong>Статус бота:</strong>
                                        <span id="botStatus" style="margin-left: 10px;">Проверка...</span>
                                    </div>
                                    <button id="refreshBotStatus" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">🔄</button>
                                </div>
                                
                                <div id="botTokenForm">
                                    <div style="margin-bottom: 10px; padding: 10px; background: #e8f5e8; border-radius: 6px; border: 1px solid #4caf50;">
                                        <strong style="color: #2e7d32;">📱 Токен бота предустановлен</strong>
                                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #388e3c;">Бот автоматически запускается с встроенным токеном</p>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button id="testBot" class="btn btn-primary" style="font-size: 12px;">🧪 Тест уведомлений</button>
                                        <button id="stopBot" class="btn btn-danger" style="font-size: 12px;">⏹️ Остановить бота</button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                    <h4 style="margin: 0 0 10px 0; color: #00796b;">Как использовать:</h4>
                                    <ol style="margin: 0; padding-left: 20px; font-size: 14px; color: #64748b;">
                                        <li>Найдите бота @taskman_productivbot в Telegram</li>
                                        <li>Добавьте бота в группу и дайте права администратора</li>
                                        <li>Начните создавать задачи командой /task</li>
                                        <li>Используйте кнопку "Тест уведомлений" для проверки</li>
                                    </ol>
                                    <div style="margin-top: 10px; padding: 8px; background: #e0f2f1; border-radius: 4px;">
                                        <strong>Команды бота:</strong><br>
                                        <code>/task задача @исполнитель описание дедлайн</code><br>
                                        <code>/tasks</code> - список задач<br>
                                        <code>/help</code> - помощь
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">🏢 Рабочий чат</label>
                            <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <label class="form-label" style="margin-bottom: 5px;">Chat ID рабочего чата:</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="workChatId" class="form-input" placeholder="-1001234567890" style="flex: 1;">
                                        <button id="saveWorkChatId" class="btn btn-primary">Сохранить</button>
                                        <button id="checkWorkChatId" class="btn btn-secondary">Проверить</button>
                                    </div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                        Добавьте бота в группу и отправьте команду /tasks чтобы получить Chat ID
                                    </div>
                                    <div id="chatInfo" style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 6px; display: none;">
                                        <!-- Информация о чате будет отображаться здесь -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Название компании</label>
                            <input type="text" class="form-input" value="Моя компания" id="companyName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Часовой пояс</label>
                            <select class="form-select" id="timezone">
                                <option>UTC+5 (Ташкент)</option>
                                <option>UTC+3 (Москва)</option>
                                <option>UTC+0 (UTC)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary">Сохранить настройки</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления задачи -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Новая задача</h3>
                <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Название задачи *</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Исполнитель *</label>
                    <select class="form-select" id="taskAssignee" required>
                        <option value="">Выберите исполнителя</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" id="taskDescription"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Дедлайн *</label>
                    <input type="datetime-local" class="form-input" id="taskDeadline" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать задачу</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно добавления сотрудника удалено -->

    <!-- Модальное окно редактирования задачи -->
    <div class="modal" id="editTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Редактировать задачу</h3>
                <button class="close-btn" onclick="closeModal('editTaskModal')">&times;</button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label class="form-label">Название задачи *</label>
                    <input type="text" class="form-input" id="editTaskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" id="editTaskDescription"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Дедлайн *</label>
                    <input type="datetime-local" class="form-input" id="editTaskDeadline" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editTaskModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Данные
        // Массив employees удален

        let tasks = [];
        let nextEmployeeId = 5;
        let currentFilter = 'all';

        // Helper функция для API вызовов с credentials
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            // Добавляем префикс /api для Firebase Functions
            const apiUrl = url.startsWith('/api') ? url : `/api${url}`;
            return fetch(apiUrl, { ...defaultOptions, ...options });
        }

        // API функции
        async function fetchTasks() {
            try {
                const response = await apiCall('/api/tasks');
                if (response.ok) {
                    tasks = await response.json();
                } else {
                    console.error('Failed to fetch tasks');
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
        }

        async function fetchStats() {
            try {
                const response = await apiCall('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    console.error('Failed to fetch stats');
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function completeTaskAPI(taskId) {
            try {
                const response = await apiCall(`/api/tasks/${taskId}/complete`, {
                    method: 'PUT'
                });
                return response.ok;
            } catch (error) {
                console.error('Error completing task:', error);
                return false;
            }
        }

        async function deleteTaskAPI(taskId) {
            try {
                const response = await apiCall(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                return response.ok;
            } catch (error) {
                console.error('Error deleting task:', error);
                return false;
            }
        }

        // Функции для управления ботом
        async function checkBotStatus() {
            try {
                const response = await apiCall('/api/bot/status');
                if (response.ok) {
                    const status = await response.json();
                    updateBotStatusDisplay(status);
                }
            } catch (error) {
                console.error('Error checking bot status:', error);
                updateBotStatusDisplay({ isRunning: false, hasToken: false });
            }
        }

        function updateBotStatusDisplay(status) {
            const statusElement = document.getElementById('botStatus');
            
            if (status.isRunning) {
                statusElement.innerHTML = '<span style="color: #4caf50;">🟢 Работает</span>';
            } else if (status.hasToken) {
                statusElement.innerHTML = '<span style="color: #ff9800;">🟡 Остановлен</span>';
            } else {
                statusElement.innerHTML = '<span style="color: #f44336;">🔴 Не настроен</span>';
            }
        }

        async function saveBotToken() {
            const token = document.getElementById('botTokenInput').value.trim();
            
            if (!token) {
                alert('Введите токен бота');
                return;
            }

            try {
                const response = await apiCall('/api/bot/token', {
                    method: 'POST',
                    body: JSON.stringify({ token })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Бот успешно запущен!');
                    document.getElementById('botTokenInput').value = '';
                    checkBotStatus();
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving bot token:', error);
                alert('Ошибка при сохранении токена');
            }
        }

        async function stopBot() {
            if (!confirm('Вы уверены, что хотите остановить бота?')) {
                return;
            }

            try {
                const response = await apiCall('/api/bot/stop', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Бот остановлен');
                    checkBotStatus();
                } else {
                    alert('Ошибка при остановке бота');
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('Ошибка при остановке бота');
            }
        }

        async function testBotNotifications() {
            try {
                // Используем тестовый chat_id для проверки
                const chatId = '1164046471'; // Тестовый chat_id
                
                console.log(`Testing notifications with chat_id: ${chatId}`);
                
                const testResponse = await apiCall('/api/bot/test', {
                    method: 'POST',
                    body: JSON.stringify({ chatId })
                });

                const result = await testResponse.json();
                
                if (testResponse.ok) {
                    alert('✅ Тестовое сообщение отправлено в Telegram!');
                } else {
                    alert(`❌ Ошибка при отправке: ${result.error}`);
                    console.error('Test error details:', result);
                }
            } catch (error) {
                console.error('Error testing bot:', error);
                alert('❌ Ошибка при тестировании бота');
            }
        }

        // Навигация
        function showPage(pageName) {
            // Скрыть все страницы
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            
            // Показать выбранную страницу
            document.getElementById(pageName + '-page').style.display = 'block';
            
            // Обновить активную навигацию
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');

            // Обновить контент
            if (pageName === 'dashboard') {
                loadDashboard();
            // Раздел employees удален
            } else if (pageName === 'analytics') {
                loadAnalytics();
            } else if (pageName === 'users') {
                loadUsers();
            } else if (pageName === 'admin') {
                loadAdminUsers();
            } else if (pageName === 'settings') {
                checkBotStatus();
                loadSettings();
            }
        }

        // Загрузка данных дашборда
        async function loadDashboard() {
            await fetchTasks();
            updateStats();
            renderTasks();
        }

        // Модальные окна
        function openTaskModal() {
            updateAssigneeSelect();
            document.getElementById('taskModal').classList.add('show');
            // Установить текущую дату и время по умолчанию
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('taskDeadline').value = now.toISOString().slice(0, 16);
        }

        // Функция openEmployeeModal удалена

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            // Очистить формы
            if (modalId === 'taskModal') {
                document.getElementById('taskForm').reset();
            }
        }

        // Обновление списка исполнителей (упрощено)
        function updateAssigneeSelect() {
            const select = document.getElementById('taskAssignee');
            select.innerHTML = '<option value="">Выберите исполнителя</option>';
            
            // Статичный список исполнителей
            const staticEmployees = [
                { id: 1, name: 'Анна Петрова', position: 'UX/UI Дизайнер' },
                { id: 2, name: 'Алексей Смирнов', position: 'Frontend Developer' },
                { id: 3, name: 'Мария Иванова', position: 'Project Manager' },
                { id: 4, name: 'Дмитрий Козлов', position: 'Backend Developer' }
            ];
            
            staticEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.position})`;
                select.appendChild(option);
            });
        }

        // Рендеринг задач
        function renderTasks() {
            const container = document.getElementById('taskList');
            const filteredTasks = tasks.filter(task => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'overdue') {
                    return task.status === 'pending' && task.deadline && new Date(task.deadline) < new Date();
                }
                return task.status === currentFilter;
            });

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        <h3>Задач не найдено</h3>
                        <p>Задачи создаются через Telegram бота командой /task</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredTasks.map(task => {
                const isOverdue = task.status === 'pending' && task.deadline && new Date(task.deadline) < new Date();
                const statusClass = isOverdue ? 'overdue' : task.status;
                
                let statusText = 'В работе';
                if (isOverdue) statusText = 'Просрочено';
                else if (task.status === 'completed') statusText = 'Выполнено';
                else if (task.status === 'review') statusText = 'На проверке';
                else if (task.status === 'revision') statusText = 'На доработке';
                
                const creatorName = task.first_name + (task.last_name ? ` ${task.last_name}` : '');
                let deadlineText = 'Не указан';
                if (task.deadline) {
                    try {
                        const deadlineDate = new Date(task.deadline);
                        deadlineText = deadlineDate.toLocaleDateString('ru-RU') + ' ' + deadlineDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    } catch (e) {
                        deadlineText = task.deadline;
                    }
                }

                return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                <span>👤 ${task.assignee_username}</span>
                                <span>📅 ${deadlineText}</span>
                                <span>👨‍💼 ${creatorName}</span>
                                ${task.time_spent_minutes ? `<span>⏱️ ${task.time_spent_minutes}м</span>` : ''}
                                ${task.efficiency_score ? `<span>📊 ${Math.round(task.efficiency_score * 100)}%</span>` : ''}
                                ${task.revision_count > 0 ? `<span>🔄 ${task.revision_count} доработок</span>` : ''}
                            </div>
                            ${task.description ? `<div style="margin-top: 5px; font-size: 13px; color: #64748b;">${task.description}</div>` : ''}
                            ${task.review_comment ? `<div style="margin-top: 5px; font-size: 13px; color: #d84315; background: #fbe9e7; padding: 8px; border-radius: 4px;"><strong>Комментарий:</strong> ${task.review_comment}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="task-status status-${statusClass}">${statusText}</span>
                            <div class="task-actions">
                                ${task.status === 'review' ? `
                                    <button class="btn btn-success" onclick="approveTaskWeb(${task.id})" style="padding: 6px 12px; font-size: 12px;">
                                        ✅ Принять
                                    </button>
                                    <button class="btn" style="background: #ff5722; color: white; padding: 6px 12px; font-size: 12px;" onclick="rejectTaskWeb(${task.id})">
                                        🔄 Отклонить
                                    </button>
                                ` : task.status === 'revision' ? `
                                    <button class="btn btn-success" onclick="approveTaskWeb(${task.id})" style="padding: 6px 12px; font-size: 12px;">
                                        ✅ Принять как есть
                                    </button>
                                ` : ''}
                                ${(task.status === 'pending' || task.status === 'revision') ? `
                                    <button class="btn" style="background: #2196f3; color: white; padding: 6px 12px; font-size: 12px;" onclick="remindTask(${task.id})">
                                        ⏰ Напомнить
                                    </button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="editTask(${task.id})" style="padding: 6px 12px; font-size: 12px;">
                                    ✏️ Редактировать
                                </button>
                                <button class="btn btn-danger" onclick="deleteTask(${task.id})" style="padding: 6px 12px; font-size: 12px;">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Функция renderEmployees удалена

        // Обновление статистики
        function updateStats() {
            fetchStats();
        }

        function updateStatsDisplay(stats) {
            document.getElementById('totalTasks').textContent = stats.total || 0;
            document.getElementById('completedTasks').textContent = stats.completed || 0;
            document.getElementById('pendingTasks').textContent = (stats.pending || 0) - (stats.overdue || 0);
            document.getElementById('overdueTasks').textContent = stats.overdue || 0;
            document.getElementById('reviewTasks').textContent = stats.review || 0;
            document.getElementById('revisionTasks').textContent = stats.revision || 0;
            
            // Новые метрики
            const avgTime = stats.avg_completion_time ? Math.round(stats.avg_completion_time) : 0;
            document.getElementById('avgCompletionTime').textContent = avgTime;
            
            const efficiency = stats.avg_efficiency ? Math.round(stats.avg_efficiency * 100) : 0;
            document.getElementById('avgEfficiency').textContent = efficiency + '%';
            
            document.getElementById('totalRevisions').textContent = stats.total_revisions || 0;
        }

        // Фильтрация задач
        function filterTasks(filter) {
            currentFilter = filter;
            
            // Обновляем активный таб
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            renderTasks();
        }

        // Операции с задачами
        async function completeTask(id) {
            const success = await completeTaskAPI(id);
            if (success) {
                await fetchTasks();
                updateStats();
                renderTasks();
            } else {
                alert('Ошибка при выполнении задачи');
            }
        }

        async function deleteTask(id) {
            if (confirm('Вы уверены, что хотите удалить эту задачу?')) {
                const success = await deleteTaskAPI(id);
                if (success) {
                    await fetchTasks();
                    updateStats();
                    renderTasks();
                } else {
                    alert('Ошибка при удалении задачи');
                }
            }
        }

        // Функции для работы с задачами через веб-интерфейс
        async function approveTaskWeb(taskId) {
            try {
                const response = await apiCall(`/api/tasks/${taskId}/approve`, {
                    method: 'PUT',
                    body: JSON.stringify({ reviewerId: 'web-admin' })
                });

                if (response.ok) {
                    await fetchTasks();
                    updateStats();
                    renderTasks();
                    alert('Задача принята! Исполнитель получил уведомление и баллы в Telegram.');
                } else {
                    alert('Ошибка при принятии задачи');
                }
            } catch (error) {
                console.error('Error approving task:', error);
                alert('Ошибка при принятии задачи');
            }
        }

        async function rejectTaskWeb(taskId) {
            const comment = prompt('Введите комментарий для доработки:');
            if (!comment) return;

            console.log(`Rejecting task ${taskId} with comment: "${comment}"`);

            try {
                const response = await apiCall(`/api/tasks/${taskId}/revision`, {
                    method: 'PUT',
                    body: JSON.stringify({ reviewerId: 'web-admin', comment })
                });

                console.log('Rejection response status:', response.status);
                const result = await response.json();
                console.log('Rejection response:', result);

                if (response.ok) {
                    await fetchTasks();
                    updateStats();
                    renderTasks();
                    alert('Задача отправлена на доработку. Исполнитель получил уведомление в Telegram.');
                } else {
                    alert(`Ошибка при отклонении задачи: ${result.error || 'Неизвестная ошибка'}`);
                }
            } catch (error) {
                console.error('Error rejecting task:', error);
                alert('Ошибка при отклонении задачи');
            }
        }

        // Функция для отправки напоминания
        async function remindTask(taskId) {
            try {
                const response = await apiCall(`/api/tasks/${taskId}/remind`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Напоминание отправлено в Telegram!');
                } else {
                    const error = await response.json();
                    alert('Ошибка при отправке напоминания: ' + (error.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Error sending reminder:', error);
                alert('Ошибка при отправке напоминания');
            }
        }


        // Функции для работы с аналитикой
        async function loadAnalytics() {
            try {
                const [detailedResponse, performanceResponse] = await Promise.all([
                    apiCall('/api/stats/detailed'),
                    apiCall('/api/stats/performance')
                ]);

                if (detailedResponse.ok) {
                    const detailedStats = await detailedResponse.json();
                    renderDetailedStats(detailedStats);
                }

                if (performanceResponse.ok) {
                    const performanceMetrics = await performanceResponse.json();
                    renderPerformanceMetrics(performanceMetrics);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function renderDetailedStats(stats) {
            const container = document.getElementById('detailedStatsContainer');
            
            if (stats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16,11V3H8v6H2v12h20V11H16z M10,5h4v14h-4V5z M4,11h4v8H4V11z M20,19h-4v-6h4V19z"/>
                        </svg>
                        <h3>Статистика недоступна</h3>
                        <p>Выполните задачи чтобы появилась аналитика</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = stats.map(stat => {
                const completionRate = stat.total_tasks > 0 ? Math.round((stat.completed_tasks / stat.total_tasks) * 100) : 0;
                const avgTime = stat.avg_time ? Math.round(stat.avg_time) : 0;
                const efficiency = stat.avg_efficiency ? Math.round(stat.avg_efficiency * 100) : 0;
                
                return `
                    <div class="employee-card" style="margin-bottom: 15px;">
                        <div class="employee-info">
                            <div class="employee-avatar">
                                ${stat.assignee_username.replace('@', '').charAt(0).toUpperCase()}
                            </div>
                            <div class="employee-details">
                                <h4>${stat.assignee_username}</h4>
                                <p>${stat.completed_tasks}/${stat.total_tasks} задач выполнено (${completionRate}%)</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #9c27b0;">${avgTime}м</div>
                                <div style="font-size: 12px; color: #64748b;">ср. время</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #607d8b;">${efficiency}%</div>
                                <div style="font-size: 12px; color: #64748b;">эффективность</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #795548;">${stat.total_revisions || 0}</div>
                                <div style="font-size: 12px; color: #64748b;">доработки</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPerformanceMetrics(metrics) {
            const container = document.getElementById('performanceMetricsContainer');
            
            if (metrics.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        <h3>Данные за период недоступны</h3>
                        <p>Создайте задачи чтобы появились метрики</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">Активность за последние дни</h4>
                </div>
                ${metrics.slice(0, 10).map(metric => {
                    const date = new Date(metric.date).toLocaleDateString('ru-RU');
                    const avgTime = metric.avg_completion_time ? Math.round(metric.avg_completion_time) : 0;
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                            <div style="font-weight: 500;">${date}</div>
                            <div style="display: flex; gap: 30px;">
                                <span style="color: #00796b;">📝 ${metric.tasks_created} создано</span>
                                <span style="color: #4caf50;">✅ ${metric.tasks_completed || 0} выполнено</span>
                                <span style="color: #9c27b0;">⏱️ ${avgTime}м среднее время</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }


        // Функции для сотрудников удалены

        // Обработчики форм
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const assigneeId = parseInt(document.getElementById('taskAssignee').value);
            const description = document.getElementById('taskDescription').value;
            const deadline = document.getElementById('taskDeadline').value;

            if (!title || !assigneeId || !deadline) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }

            const newTask = {
                id: nextTaskId++,
                title,
                assigneeId,
                description,
                deadline,
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: 'Текущий пользователь'
            };

            tasks.unshift(newTask);
            updateStats();
            renderTasks();
            closeModal('taskModal');
        });

        // Обработчик формы employeeForm удален

        // Функция редактирования задачи
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                alert('Задача не найдена');
                return;
            }
            
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description || '';
            
            // Правильно устанавливаем дату и время
            if (task.deadline) {
                // Если дедлайн содержит только дату, добавляем время
                let dateTimeValue = task.deadline;
                if (task.deadline.length === 10) { // Только дата (YYYY-MM-DD)
                    dateTimeValue = task.deadline + 'T23:59';
                } else if (task.deadline.includes(' ')) {
                    // Преобразуем формат "YYYY-MM-DD HH:MM" в "YYYY-MM-DDTHH:MM"
                    dateTimeValue = task.deadline.replace(' ', 'T');
                }
                document.getElementById('editTaskDeadline').value = dateTimeValue;
            }
            
            document.getElementById('editTaskModal').classList.add('show');
        }

        // Обработчик формы редактирования задачи
        document.getElementById('editTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value;
            const description = document.getElementById('editTaskDescription').value;
            const deadline = document.getElementById('editTaskDeadline').value;

            if (!title || !deadline) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }

            try {
                const response = await apiCall(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ title, description, deadline })
                });

                if (response.ok) {
                    await fetchTasks();
                    updateStats();
                    renderTasks();
                    closeModal('editTaskModal');
                    alert('Задача успешно обновлена');
                } else {
                    alert('Ошибка при обновлении задачи');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Ошибка при обновлении задачи');
            }
        });

        // Закрытие модальных окон по клику на фон
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Адаптивность - мобильное меню
        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        // Функции для работы с пользователем (без авторизации)
        async function loadUserInfo() {
            // Убрана проверка авторизации - показываем фиктивного пользователя
            const user = {
                name: 'Пользователь',
                email: 'user@taskmanager.local',
                role: 'admin'
            };
            displayUserInfo(user);
            
            // Показываем админ раздел если пользователь админ
            if (user.role === 'admin') {
                document.getElementById('adminNavItem').style.display = 'flex';
            }
            
            return true;
        }

        function displayUserInfo(user) {
            document.getElementById('userName').textContent = user.name || user.email;
            document.getElementById('userRole').textContent = getRoleName(user.role);
            
            const avatar = document.getElementById('userAvatar');
            if (user.avatar) {
                avatar.src = user.avatar;
                avatar.style.display = 'block';
            } else {
                avatar.style.display = 'none';
            }
        }

        function getRoleName(role) {
            switch (role) {
                case 'admin': return 'Администратор';
                case 'manager': return 'Менеджер';
                case 'executor': return 'Исполнитель';
                default: return 'Пользователь';
            }
        }

        function logout() {
            if (confirm('Вы уверены, что хотите перезагрузить страницу?')) {
                window.location.reload();
            }
        }

        // Функции для управления пользователями
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                const users = await response.json();
                renderUsers(users);
            } catch (error) {
                console.error('Error loading users:', error);
                renderUsers([]);
            }
        }

        // Функция для обновления списка пользователей
        async function refreshUsers() {
            try {
                showNotification('Обновление списка пользователей...', 'info');
                
                const response = await fetch('/api/admin/users/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to refresh users');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    renderUsers(result.users);
                    let message = `Список обновлен! `;
                    if (result.total_chat_members) {
                        message += `В чате ${result.chat_id}: ${result.total_chat_members} участников, ${result.users_in_db} взаимодействовали с ботом`;
                    } else {
                        message += `Найдено ${result.users.length} пользователей из чата ${result.chat_id}`;
                    }
                    if (result.warning) {
                        message += ` (${result.warning})`;
                    }
                    showNotification(message, 'success');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error refreshing users:', error);
                showNotification('Ошибка при обновлении списка пользователей: ' + error.message, 'error');
            }
        }

        function renderUsers(users) {
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2c2.21 0 4 1.79 4 4 0 2.21-1.59 3.92-3.75 4l.75.75 2.25 2.25c.39.39.39 1.02 0 1.41s-1.02.39-1.41 0L11.59 12.16c-.59.13-1.2.34-1.8.34C7.58 12.5 6 10.92 6 9s1.58-3.5 3.79-3.5zM10 7c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
                        </svg>
                        <h3>Пользователей нет</h3>
                        <p>Пользователи появятся после взаимодействия с ботом</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = users.map(user => {
                const roleColor = user.role === 'admin' ? '#f44336' : user.role === 'manager' ? '#ff9800' : '#4caf50';
                const roleName = user.role === 'admin' ? 'Администратор' : user.role === 'manager' ? 'Менеджер' : 'Исполнитель';
                
                return `
                    <div class="employee-card" style="margin-bottom: 15px;">
                        <div class="employee-info">
                            <div class="employee-avatar">
                                ${(user.first_name || user.username || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div class="employee-details">
                                <h4>${user.first_name || 'Неизвестно'}${user.last_name ? ` ${user.last_name}` : ''}</h4>
                                <p>@${user.username || 'unknown'} • 💎 ${user.points || 0} баллов</p>
                                <p style="color: ${roleColor}; font-weight: 600;">${roleName}</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <select onchange="updateUserRole('${user.user_id}', this.value)" class="form-select" style="width: 150px;">
                                <option value="executor" ${user.role === 'executor' ? 'selected' : ''}>Исполнитель</option>
                                <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Менеджер</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Администратор</option>
                            </select>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateUserRole(userId, role) {
            try {
                const response = await apiCall(`/api/users/${userId}/role`, {
                    method: 'PUT',
                    body: JSON.stringify({ role })
                });

                if (response.ok) {
                    alert('Роль пользователя обновлена!');
                    loadUsers(); // Перезагружаем список
                } else {
                    alert('Ошибка при обновлении роли');
                }
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('Ошибка при обновлении роли');
            }
        }

        // Функции для работы с настройками
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    const settings = await response.json();
                    applySettings(settings);
                }
                
                // Добавляем обработчики событий для кнопок настроек после загрузки
                setTimeout(() => {
                    const saveBtn = document.getElementById('saveWorkChatId');
                    const checkBtn = document.getElementById('checkWorkChatId');
                    
                    if (saveBtn && !saveBtn.hasAttribute('data-listener')) {
                        saveBtn.addEventListener('click', saveWorkChatId);
                        saveBtn.setAttribute('data-listener', 'true');
                        console.log('Save button listener added');
                    }
                    
                    if (checkBtn && !checkBtn.hasAttribute('data-listener')) {
                        checkBtn.addEventListener('click', checkWorkChatId);
                        checkBtn.setAttribute('data-listener', 'true');
                        console.log('Check button listener added');
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function applySettings(settings) {
            const workChatId = settings.find(s => s.key === 'work_chat_id');
            if (workChatId && workChatId.value) {
                document.getElementById('workChatId').value = workChatId.value;
                // Автоматически проверяем чат при загрузке настроек
                checkWorkChatId();
            }
        }

        async function saveWorkChatId() {
            const chatId = document.getElementById('workChatId').value.trim();
            
            if (!chatId) {
                showNotification('Введите Chat ID', 'error');
                return;
            }

            try {
                const response = await fetch('/api/settings/work_chat_id', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: chatId })
                });

                if (response.ok) {
                    showNotification('Chat ID сохранен!', 'success');
                    // Проверяем информацию о чате после сохранения
                    await checkWorkChatId();
                } else {
                    showNotification('Ошибка при сохранении Chat ID', 'error');
                }
            } catch (error) {
                console.error('Error saving chat ID:', error);
                showNotification('Ошибка при сохранении Chat ID', 'error');
            }
        }

        async function checkWorkChatId() {
            const chatId = document.getElementById('workChatId').value.trim();
            const chatInfoDiv = document.getElementById('chatInfo');
            
            if (!chatId) {
                chatInfoDiv.style.display = 'none';
                return;
            }

            try {
                showNotification('Проверяем информацию о чате...', 'info');
                
                const response = await fetch('/api/admin/chat/info');
                
                if (!response.ok) {
                    throw new Error('Failed to get chat info');
                }
                
                const result = await response.json();
                
                if (result.success && result.chat) {
                    const chat = result.chat;
                    chatInfoDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" style="color: #4caf50;">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <strong style="color: #2d5016;">Чат подключен успешно!</strong>
                        </div>
                        <div style="font-size: 14px; line-height: 1.4;">
                            <div><strong>Название:</strong> ${chat.title || 'Не указано'}</div>
                            <div><strong>ID:</strong> ${chat.id}</div>
                            <div><strong>Тип:</strong> ${chat.type}</div>
                            <div><strong>Участников:</strong> ${chat.members_count}</div>
                            ${chat.description ? `<div><strong>Описание:</strong> ${chat.description}</div>` : ''}
                        </div>
                    `;
                    chatInfoDiv.style.display = 'block';
                    chatInfoDiv.style.background = '#e8f5e8';
                    chatInfoDiv.style.border = '1px solid #4caf50';
                    
                    showNotification(`Чат "${chat.title}" подключен! Участников: ${chat.members_count}`, 'success');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error checking chat info:', error);
                chatInfoDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: #d32f2f;">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <strong>Ошибка подключения к чату</strong>
                    </div>
                    <div style="font-size: 14px; margin-top: 5px; color: #666;">
                        ${error.message || 'Проверьте Chat ID и убедитесь что бот добавлен в группу'}
                    </div>
                `;
                chatInfoDiv.style.display = 'block';
                chatInfoDiv.style.background = '#ffeaea';
                chatInfoDiv.style.border = '1px solid #d32f2f';
                
                showNotification('Ошибка при проверке чата: ' + error.message, 'error');
            }
        }

        // Функции для админ панели
        async function loadAdminUsers() {
            try {
                const response = await apiCall('/api/admin/users');
                if (response.ok) {
                    const users = await response.json();
                    renderAdminUsers(users);
                } else {
                    console.error('Failed to load admin users');
                }
            } catch (error) {
                console.error('Error loading admin users:', error);
            }
        }

        function renderAdminUsers(users) {
            const container = document.getElementById('adminUsersList');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2c2.21 0 4 1.79 4 4 0 2.21-1.59 3.92-3.75 4l.75.75 2.25 2.25c.39.39.39 1.02 0 1.41s-1.02.39-1.41 0L11.59 12.16c-.59.13-1.2.34-1.8.34C7.58 12.5 6 10.92 6 9s1.58-3.5 3.79-3.5zM10 7c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
                        </svg>
                        <h3>Пользователей пока нет</h3>
                        <p>Пользователи появятся после отправки команд боту @workprobusinessbot<br>
                        Токен: 7539351581:AAGn9-Q6xAhfB99ZMm8Ym3Z7HauG8yuzuzg</p>
                    </div>
                `;
                return;
            }

            // Статистика сверху
            const totalUsers = users.length;
            const adminCount = users.filter(u => u.role === 'admin').length;
            const managerCount = users.filter(u => u.role === 'manager').length;
            const executorCount = users.filter(u => u.role === 'executor').length;
            const totalPoints = users.reduce((sum, user) => sum + (user.points || 0), 0);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #00796b;">${totalUsers}</div>
                        <div style="font-size: 12px; color: #64748b;">Всего пользователей</div>
                    </div>
                    <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #f44336;">${adminCount}</div>
                        <div style="font-size: 12px; color: #64748b;">Администраторов</div>
                    </div>
                    <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #ff9800;">${managerCount}</div>
                        <div style="font-size: 12px; color: #64748b;">Менеджеров</div>
                    </div>
                    <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #4caf50;">${executorCount}</div>
                        <div style="font-size: 12px; color: #64748b;">Исполнителей</div>
                    </div>
                    <div style="background: #f8faf9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #9c27b0;">${totalPoints}</div>
                        <div style="font-size: 12px; color: #64748b;">Общий рейтинг</div>
                    </div>
                </div>
                ${users.map(user => {
                    const roleColor = user.role === 'admin' ? '#f44336' : user.role === 'manager' ? '#ff9800' : '#4caf50';
                    const roleName = user.role === 'admin' ? '🔴 Администратор' : user.role === 'manager' ? '🟠 Менеджер' : '🟢 Исполнитель';
                    const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString('ru-RU') : 'Неизвестно';
                    const activationStatus = user.username ? '✅ Активирован' : '⏳ Ожидает активации';
                    
                    return `
                        <div class="employee-card" style="margin-bottom: 15px; border-left: 4px solid ${roleColor};">
                            <div class="employee-info">
                                <div class="employee-avatar" style="background: ${roleColor};">
                                    ${(user.first_name || user.username || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="employee-details">
                                    <h4>${user.first_name || 'Неизвестно'}${user.last_name ? ` ${user.last_name}` : ''}</h4>
                                    <p>@${user.username || 'unknown'} • Telegram ID: ${user.user_id}</p>
                                    <p style="color: ${roleColor}; font-weight: 600;">${roleName}</p>
                                    <p style="font-size: 12px; color: #64748b;">
                                        📅 Зарегистрирован: ${createdDate} • ${activationStatus}
                                    </p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #00796b;">${user.points || 0}</div>
                                    <div style="font-size: 12px; color: #64748b;">баллов</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #2196f3;">${user.balance || '0.00'}</div>
                                    <div style="font-size: 12px; color: #64748b;">баланс</div>
                                </div>
                                <div style="text-align: center;">
                                    <button class="btn btn-secondary" onclick="promoteToAdmin('${user.user_id}')" style="padding: 4px 8px; font-size: 12px;">
                                        👑 Сделать админом
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // Функция для повышения пользователя до администратора
        async function promoteToAdmin(userId) {
            if (!confirm('Вы уверены, что хотите назначить этого пользователя администратором?')) {
                return;
            }

            try {
                const response = await apiCall(`/api/users/${userId}/role`, {
                    method: 'PUT',
                    body: JSON.stringify({ role: 'admin' })
                });

                if (response.ok) {
                    alert('Пользователь назначен администратором!');
                    loadAdminUsers(); // Перезагружаем список
                } else {
                    alert('Ошибка при назначении администратора');
                }
            } catch (error) {
                console.error('Error promoting user to admin:', error);
                alert('Ошибка при назначении администратора');
            }
        }

        // Инициализация
        async function initApp() {
            const isAuthenticated = await loadUserInfo();
            if (isAuthenticated) {
                updateAssigneeSelect();
                await loadDashboard();
                
                // Обработчики для управления ботом
                document.getElementById('stopBot').addEventListener('click', stopBot);
                document.getElementById('testBot').addEventListener('click', testBotNotifications);
                document.getElementById('refreshBotStatus').addEventListener('click', checkBotStatus);
                
                // Автоматическое обновление каждые 30 секунд
                setInterval(async () => {
                    if (document.querySelector('.nav-item.active').textContent.includes('Дашборд')) {
                        await fetchTasks();
                        updateStats();
                        renderTasks();
                    }
                }, 30000);
            }
        }

        // Запуск приложения
        initApp();
    </script>
</body>
</html>
                